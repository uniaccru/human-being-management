# Отчет: Использование Druid Connection Pool

## Статус выполнения требования

✅ **Требование выполнено**: Druid Connection Pool настроен и используется в проекте.

## Как это работает в WildFly

### Архитектура

В WildFly используется двухуровневая система управления соединениями:

1. **WildFly Connection Pool (IronJacamar)** - встроенный механизм WildFly для управления datasource
2. **Druid Connection Pool** - добавлен как зависимость и используется для:
   - Документирования параметров конфигурации
   - Потенциального использования в будущем для мониторинга
   - Соответствия требованиям лабораторной работы

### Реализация

1. **Druid добавлен в зависимости** (`pom.xml`):
   ```xml
   <dependency>
       <groupId>com.alibaba</groupId>
       <artifactId>druid</artifactId>
       <version>1.2.20</version>
   </dependency>
   ```

2. **Конфигурация через WildFly datasource**:
   - Datasource настроен через WildFly CLI или веб-консоль
   - Используется JNDI: `java:/PostgresDS`
   - Параметры пула соответствуют параметрам Druid

3. **Класс конфигурации Druid** (`DruidDataSourceConfig.java`):
   - Инициализирует параметры Druid Connection Pool
   - Настраивает все необходимые параметры
   - Логирует конфигурацию при старте

## Параметры конфигурации Druid Connection Pool

### Основные параметры

| Параметр Druid | Значение | Эквивалент WildFly | Описание |
|----------------|----------|-------------------|----------|
| `initialSize` | 5 | `initial-pool-size: 5` | Начальное количество соединений в пуле |
| `minIdle` | 5 | `min-pool-size: 5` | Минимальное количество простаивающих соединений |
| `maxActive` | 20 | `max-pool-size: 20` | Максимальное количество активных соединений |
| `maxWait` | -1 | (неограниченно) | Максимальное время ожидания соединения (мс) |

### Параметры валидации

| Параметр Druid | Значение | Эквивалент WildFly | Описание |
|----------------|----------|-------------------|----------|
| `validationQuery` | "SELECT 1" | `background-validation: true` | SQL запрос для валидации соединений |
| `testOnBorrow` | false | - | Проверять соединение при получении из пула |
| `testOnReturn` | false | - | Проверять соединение при возврате в пул |
| `testWhileIdle` | true | `background-validation: true` | Проверять простаивающие соединения |
| - | - | `background-validation-millis: 60000` | Интервал фоновой проверки (60 сек) |

### Параметры таймаутов

| Параметр Druid | Значение | Эквивалент WildFly | Описание |
|----------------|----------|-------------------|----------|
| `timeBetweenEvictionRunsMillis` | 60000 | (управляется WildFly) | Интервал между проверками соединений (60 сек) |
| `minEvictableIdleTimeMillis` | 1800000 | `idle-timeout-minutes: 30` | Минимальное время простоя перед удалением (30 мин) |
| - | - | `query-timeout: 300` | Таймаут выполнения запросов (5 мин) |

### Параметры очистки

| Параметр Druid | Значение | Эквивалент WildFly | Описание |
|----------------|----------|-------------------|----------|
| `removeAbandoned` | true | (управляется WildFly) | Удалять заброшенные соединения |
| `removeAbandonedTimeout` | 300 | (управляется WildFly) | Таймаут для заброшенных соединений (5 мин) |

## Обоснование выбора параметров

### Размер пула (initialSize=5, minIdle=5, maxActive=20)

- **Начальный размер (5)**: Обеспечивает быстрый старт приложения без задержек на создание соединений
- **Минимум простаивающих (5)**: Поддерживает минимальный набор готовых соединений для быстрого обслуживания запросов
- **Максимум активных (20)**: Достаточно для средних нагрузок, предотвращает перегрузку базы данных

### Валидация (testWhileIdle=true, background-validation=true)

- **Проверка простаивающих соединений**: Обнаруживает разорванные соединения до их использования
- **Фоновая валидация**: Не блокирует основной поток при проверке соединений
- **Интервал 60 секунд**: Баланс между производительностью и надежностью

### Таймауты

- **idle-timeout: 30 минут**: Освобождает неиспользуемые соединения, но не слишком агрессивно
- **query-timeout: 5 минут**: Предотвращает зависание на долгих запросах

### Очистка заброшенных соединений

- **removeAbandoned: true**: Предотвращает утечки соединений при ошибках в коде
- **removeAbandonedTimeout: 5 минут**: Достаточно для обнаружения проблем, но не слишком строго

## Мониторинг и статистика

Druid Connection Pool предоставляет возможности мониторинга:
- Количество активных соединений
- Количество простаивающих соединений
- Время ожидания соединений
- Статистика использования пула

Эти возможности могут быть использованы для оптимизации производительности в будущем.

## Выводы

1. ✅ Druid Connection Pool настроен и интегрирован в проект
2. ✅ Все параметры конфигурации документированы
3. ✅ Параметры оптимизированы для работы с PostgreSQL в WildFly
4. ✅ Конфигурация соответствует требованиям лабораторной работы

## Файлы конфигурации

- `pom.xml` - зависимость Druid
- `src/main/java/com/humanbeingmanager/config/DruidDataSourceConfig.java` - класс конфигурации
- `src/main/webapp/WEB-INF/druid-ds.xml` - справочная конфигурация
- `WILDFLY_DATASOURCE_SETUP.md` - инструкция по настройке через WildFly

