# Пошаговая инструкция по проверке проекта

## Шаг 1: Подготовка окружения

### 1.1 Запуск MinIO локально

Откройте терминал и выполните:

```bash
docker run -d -p 9000:9000 -p 9001:9001 \
  --name minio \
  -e MINIO_ROOT_USER=minioadmin \
  -e MINIO_ROOT_PASSWORD=minioadmin \
  minio/minio server /data --console-address ":9001"
```

Проверьте, что MinIO запустился:
- Откройте браузер: http://localhost:9001
- Логин: `minioadmin`
- Пароль: `minioadmin`
- Должен быть виден интерфейс MinIO

### 1.2 Настройка переменных окружения на WildFly сервере

На удаленном сервере, где запущен WildFly, установите переменные окружения:

```bash
export MINIO_ENDPOINT=http://ВАШ_IP_АДРЕС:9000
export MINIO_ACCESS_KEY=minioadmin
export MINIO_SECRET_KEY=minioadmin
export MINIO_BUCKET_NAME=import-files
```

**Важно**: Замените `ВАШ_IP_АДРЕС` на IP-адрес вашего компьютера (не localhost!). 
Узнать IP можно командой:
- Linux/Mac: `ifconfig` или `ip addr`
- Windows: `ipconfig`

Пример:
```bash
export MINIO_ENDPOINT=http://192.168.1.100:9000
```

### 1.3 Сборка проекта

В корне проекта выполните:

```bash
mvn clean package
```

Должен создаться файл `target/human-being-manager.war`

---

## Шаг 2: Проверка Druid Connection Pool

### 2.1 Проверка конфигурации

1. Откройте файл `src/main/webapp/WEB-INF/druid-ds.xml`
2. Убедитесь, что параметры пула настроены:
   - `min-pool-size`: 5
   - `max-pool-size`: 20
   - `initial-pool-size`: 5

### 2.2 Деплой на WildFly

1. Скопируйте `target/human-being-manager.war` на сервер WildFly
2. Деплойте через консоль WildFly или скопируйте в `deployments/`
3. Проверьте логи WildFly - не должно быть ошибок подключения к БД

### 2.3 Проверка работы

1. Откройте приложение в браузере
2. Попробуйте создать/изменить/удалить HumanBeing
3. Если все работает - пул соединений работает корректно

**Что проверить в отчете:**
- Записать параметры конфигурации из `druid-ds.xml`
- Описать, как они влияют на производительность

---

## Шаг 3: Проверка L2 JPA Cache (Ehcache)

### 3.1 Проверка конфигурации Ehcache

1. Откройте файл `src/main/resources/ehcache.xml`
2. Убедитесь, что кэши настроены для всех сущностей

### 3.2 Проверка аннотаций @Cacheable

Проверьте, что в файлах есть аннотация `@Cacheable(true)`:
- `HumanBeing.java`
- `Car.java`
- `ImportHistory.java`

### 3.3 Тестирование кэша

1. Откройте приложение
2. Откройте какого-то HumanBeing (например, ID=1)
3. Закройте и снова откройте того же HumanBeing
4. Второй раз должно быть быстрее (данные из кэша)

### 3.4 Включение логирования статистики кэша

На WildFly сервере установите системное свойство:

```bash
# В файле запуска WildFly или через CLI
-Dcache.statistics.enabled=true
```

Или через WildFly CLI:
```bash
/system-property=cache.statistics.enabled:add(value=true)
```

Проверьте логи - должны появиться сообщения о статистике кэша.

**Что проверить в отчете:**
- Записать параметры из `ehcache.xml`
- Объяснить, как они влияют на уровень хранения (memory, disk, offheap)

---

## Шаг 4: Проверка MinIO интеграции

### 4.1 Проверка подключения

1. Убедитесь, что MinIO запущен (Шаг 1.1)
2. Убедитесь, что переменные окружения установлены (Шаг 1.2)
3. Перезапустите WildFly после установки переменных окружения

### 4.2 Проверка загрузки файла

1. Откройте приложение в браузере
2. Перейдите в раздел "Импорт"
3. Нажмите "Выбрать JSON файл"
4. Выберите файл `example_import.json` (или любой другой JSON с HumanBeings)
5. Дождитесь завершения импорта

**Что должно произойти:**
- Файл должен загрузиться
- В таблице истории импорта должна появиться запись
- В колонке "Файл" должна быть кнопка "Скачать"

### 4.3 Проверка скачивания файла

1. В таблице истории импорта найдите запись с файлом
2. Нажмите кнопку "Скачать"
3. Файл должен скачаться

### 4.4 Проверка в MinIO консоли

1. Откройте http://localhost:9001
2. Войдите в MinIO
3. Должен быть создан bucket `import-files`
4. В bucket должны быть загруженные файлы

**Что проверить:**
- Файлы сохраняются в MinIO
- Файлы можно скачать через интерфейс приложения

---

## Шаг 5: Проверка распределенных транзакций

### 5.1 Нормальный сценарий (все работает)

1. Загрузите файл через интерфейс (как в Шаге 4.2)
2. Проверьте, что:
   - Данные появились в БД (откройте список HumanBeings)
   - Файл появился в MinIO
   - В истории импорта есть запись с fileKey

### 5.2 Сценарий 1: Отказ MinIO (БД работает)

**Подготовка:**
1. Остановите MinIO: `docker stop minio`
2. Или измените `MINIO_ENDPOINT` на неверный адрес

**Тест:**
1. Попробуйте загрузить файл через интерфейс
2. Должна появиться ошибка
3. Проверьте БД - **НЕ должно быть** новых записей (транзакция откатилась)

**Ожидаемый результат:**
- Ошибка при загрузке
- Данные НЕ сохранились в БД
- В истории импорта может быть запись с ошибкой, но без fileKey

### 5.3 Сценарий 2: Отказ БД (MinIO работает)

**Подготовка:**
1. Остановите PostgreSQL (если возможно)
2. Или измените `DATABASE_URL` на неверный

**Тест:**
1. Попробуйте загрузить файл
2. Должна появиться ошибка
3. Проверьте MinIO - **НЕ должно быть** файла (или должен быть удален)

**Ожидаемый результат:**
- Ошибка при загрузке
- Файл НЕ сохранился в MinIO (или был удален при rollback)

### 5.4 Сценарий 3: Ошибка в бизнес-логике

**Подготовка:**
Создайте файл с невалидными данными (например, без обязательных полей)

**Тест:**
1. Загрузите файл с ошибками валидации
2. Должна появиться ошибка валидации
3. Проверьте:
   - БД - НЕ должно быть новых записей
   - MinIO - НЕ должно быть файла

**Ожидаемый результат:**
- Ошибка валидации
- Данные НЕ сохранились в БД
- Файл НЕ сохранился в MinIO

---

## Шаг 6: Проверка параллельных запросов

### 6.1 Подготовка тестового файла

Создайте несколько JSON файлов с разными данными:
- `test1.json`
- `test2.json`
- `test3.json`

### 6.2 Параллельная загрузка

**Вариант 1: Через браузер (вручную)**
1. Откройте приложение в нескольких вкладках браузера
2. Одновременно загрузите разные файлы
3. Все должны обработаться корректно

**Вариант 2: Через Apache JMeter (как в ЛР 2)**
1. Создайте тест-план для импорта
2. Запустите несколько потоков одновременно
3. Проверьте, что все запросы обработались

**Что проверить:**
- Все файлы загрузились
- Все данные сохранились в БД
- Все файлы сохранились в MinIO
- Нет конфликтов или ошибок

**Что описать в отчете:**
- Примеры ситуаций при параллельных запросах
- Как реализация обрабатывает такие ситуации (thread-safety, уникальные transaction ID)

---

## Шаг 7: Финальная проверка и остановка

### 7.1 Проверка всех функций

Пройдитесь по всем функциям приложения:
- ✅ Создание HumanBeing
- ✅ Редактирование HumanBeing
- ✅ Удаление HumanBeing
- ✅ Импорт через файл
- ✅ Скачивание файлов из истории
- ✅ Просмотр истории импорта

### 7.2 Остановка всех сервисов

**Остановите MinIO:**
```bash
docker stop minio
docker rm minio
```

**Остановите WildFly:**
```bash
# На сервере WildFly
./stop.sh
# или
$WILDFLY_HOME/bin/jboss-cli.sh --connect command=:shutdown
```

**Остановите БД (если локально):**
```bash
docker-compose down
```

---

## Чек-лист для защиты

- [ ] MinIO запущен и доступен
- [ ] Druid Connection Pool настроен и работает
- [ ] L2 JPA Cache (Ehcache) настроен и работает
- [ ] Логирование статистики кэша можно включить/выключить
- [ ] Файлы загружаются в MinIO
- [ ] Файлы можно скачать из истории импорта
- [ ] Распределенные транзакции работают корректно:
  - [ ] Отказ MinIO → откат БД
  - [ ] Отказ БД → удаление файла из MinIO
  - [ ] Ошибка бизнес-логики → откат обеих операций
- [ ] Параллельные запросы обрабатываются корректно
- [ ] Все сервисы можно остановить после демонстрации

---

## Полезные команды для отладки

**Проверка логов WildFly:**
```bash
tail -f $WILDFLY_HOME/standalone/log/server.log
```

**Проверка подключения к MinIO:**
```bash
curl http://localhost:9000/minio/health/live
```

**Проверка переменных окружения:**
```bash
env | grep MINIO
```

**Проверка статуса MinIO контейнера:**
```bash
docker ps | grep minio
```

