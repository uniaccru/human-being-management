# JMeter Тест Изоляции Транзакций для HumanBeing Manager

## Описание

Этот JMeter тест-план проверяет корректность изоляции транзакций в HumanBeing Manager API при одновременной работе нескольких пользователей.

## Требования

- Apache JMeter 5.6+ 
- JDK 11+
- Доступ к развернутому приложению HumanBeing Manager на WildFly

## Настройка перед запуском

1. Откройте файл `HumanBeingTransactionTest.jmx` в JMeter
2. Проверьте/измените переменные в `User Defined Variables`:
   - `SERVER_HOST`: хост сервера (по умолчанию: `localhost`)
   - `SERVER_PORT`: порт сервера (по умолчанию: `24180`)
   - `BASE_PATH`: базовый путь API (по умолчанию: `/human-being-manager/api`)
   - `THREAD_COUNT`: количество одновременных пользователей (по умолчанию: `5`)
   - `RAMP_UP`: время набора пользователей в секундах (по умолчанию: `1`)

## Структура тестов

### Setup: Create Test Object
- **Назначение**: Создает начальный тестовый объект для последующих тестов
- **Операция**: POST /api/humanbeings
- **Проверка**: Код ответа 201

### Test 1: Concurrent Create - Uniqueness Check
- **Назначение**: Проверяет корректность проверки уникальности координат при одновременном создании объектов
- **Операция**: POST /api/humanbeings с одинаковыми координатами (x=500, y=600.5)
- **Ожидаемый результат**: 
  - Только один запрос должен вернуть 201 (успешное создание)
  - Остальные запросы должны вернуть 400 (ошибка валидации - дубликат координат)
- **Проверяет**: Корректность работы `PESSIMISTIC_WRITE` блокировки в `findByCoordinates`

### Test 2: Concurrent Update - Same Object
- **Назначение**: Проверяет поведение системы при одновременном обновлении одного объекта несколькими пользователями
- **Операция**: 
  1. GET /api/humanbeings/{id} - получение объекта
  2. PUT /api/humanbeings/{id} - обновление (выполняется 3 раза в цикле)
- **Ожидаемый результат**: 
  - Все обновления должны завершиться с кодом 200
  - Данные должны сохраняться корректно (последнее обновление должно быть видно)
- **Проверяет**: Изоляцию транзакций при UPDATE операциях

### Test 3: Concurrent Delete - Same Object
- **Назначение**: Проверяет поведение системы при одновременном удалении одного объекта
- **Операция**: 
  1. POST /api/humanbeings - создание объекта для удаления
  2. DELETE /api/humanbeings/{id} - одновременное удаление
- **Ожидаемый результат**: 
  - Только один запрос должен вернуть 204 (успешное удаление)
  - Остальные запросы должны вернуть 404 (объект не найден)
- **Проверяет**: Корректность изоляции при DELETE операциях

### Test 4: Concurrent Import
- **Назначение**: Проверяет корректность импорта при одновременных запросах
- **Операция**: POST /api/import/humanbeings с массивом объектов
- **Ожидаемый результат**: 
  - Импорт должен завершаться успешно (200) или с ошибкой валидации (400)
  - Транзакция должна быть атомарной (все объекты импортируются или ни один)
- **Проверяет**: Атомарность транзакций при импорте

### Test 5: General CRUD Operations
- **Назначение**: Проверяет базовые CRUD операции при параллельной работе
- **Операция**: 
  1. POST /api/humanbeings - создание
  2. GET /api/humanbeings/{id} - чтение
  3. PUT /api/humanbeings/{id} - обновление
  4. DELETE /api/humanbeings/{id} - удаление
- **Ожидаемый результат**: Все операции должны выполняться успешно
- **Проверяет**: Общую работоспособность CRUD операций

## Запуск теста

### Графический режим (GUI)
```bash
jmeter -n -t HumanBeingTransactionTest.jmx
```

### Неграфический режим (CLI) - рекомендуется для серьезных нагрузочных тестов
```bash
jmeter -n -t HumanBeingTransactionTest.jmx -l results.jtl -e -o report/
```

Параметры:
- `-n`: неграфический режим
- `-t`: путь к тест-плану
- `-l`: путь к файлу результатов (.jtl)
- `-e`: создание HTML отчета
- `-o`: директория для HTML отчета

## Анализ результатов

### Ключевые метрики для проверки:

1. **Uniqueness Test (Test 1)**:
   - Проверьте в "View Results Tree", что только один запрос вернул 201
   - Остальные должны вернуть 400 с сообщением о дубликате координат
   - Если несколько запросов вернули 201 - это нарушение уникальности!

2. **Concurrent Update (Test 2)**:
   - Все запросы должны вернуть 200
   - Проверьте логи сервера - не должно быть ошибок "optimistic locking"
   - Проверьте итоговое состояние объекта после всех обновлений

3. **Concurrent Delete (Test 3)**:
   - Только один DELETE должен вернуть 204
   - Остальные должны вернуть 404
   - Если несколько DELETE вернули 204 - это проблема с изоляцией!

4. **Import Test (Test 4)**:
   - Импорт должен быть атомарным
   - При ошибке валидации - ни один объект не должен быть создан
   - Проверьте таблицу импорта - транзакции должны корректно откатываться

### Summary Report
Проверьте:
- **Error %**: должен быть низким для успешных операций
- **Average/Median/Min/Max**: время ответа
- **Throughput**: количество запросов в секунду

### Aggregate Report
- Проверьте распределение кодов ответов
- Убедитесь, что нет неожиданных ошибок (5xx)

## Интерпретация результатов для изоляции транзакций

### Уровень изоляции транзакций

Текущая реализация использует:
- **JTA транзакции** (контейнерное управление)
- **PESSIMISTIC_WRITE** блокировка для проверки уникальности координат
- **EJB @TransactionAttribute(REQUIRED)** - транзакции начинаются автоматически

### Ожидаемое поведение:

1. **READ COMMITTED** (по умолчанию в большинстве БД):
   - Позволяет читать зафиксированные изменения
   - Может быть недостаточно для предотвращения phantom reads при импорте

2. **REPEATABLE READ** или **SERIALIZABLE**:
   - Рекомендуется для операций импорта и проверки уникальности
   - Гарантирует отсутствие phantom reads

### Рекомендации по изменению уровня изоляции:

Если тесты показывают проблемы:

1. **Для операций проверки уникальности**:
   - Уже используется `PESSIMISTIC_WRITE` - должно быть достаточно
   - Если все еще возникают дубликаты - рассмотрите уникальный индекс в БД

2. **Для операций импорта**:
   - В `persistence.xml` можно добавить:
   ```xml
   <property name="jakarta.persistence.lock.timeout" value="5000"/>
   ```

3. **Для UPDATE операций**:
   - Рассмотрите использование версионирования (@Version в сущности)
   - Это предотвратит lost updates

## Проверка логов сервера

После запуска тестов проверьте логи WildFly (`standalone/log/server.log`):

1. **Ошибки транзакций**:
   - `TransactionRolledBackException`
   - `OptimisticLockException`
   - `PessimisticLockException`

2. **Успешные операции**:
   - `Successfully created HumanBeing`
   - `Successfully updated HumanBeing`
   - `Import completed successfully`

## Очистка после тестов

Тесты создают тестовые данные. Для очистки можно использовать:
- DELETE запросы через API
- SQL скрипт для очистки таблиц (если есть доступ к БД)

## Дополнительные рекомендации

1. **Для серьезной нагрузки**: увеличьте `THREAD_COUNT` до 10-20 пользователей
2. **Для проверки таймаутов**: увеличьте `RAMP_UP` до 5-10 секунд
3. **Для долгого тестирования**: добавьте циклы в Thread Groups
4. **Мониторинг БД**: следите за количеством активных соединений и блокировок

## Известные ограничения

- Тесты используют случайные координаты для избежания конфликтов
- Тест уникальности использует фиксированные координаты (500, 600.5)
- Импорт тесты создают объекты с широким диапазоном координат

## Поддержка

При возникновении проблем:
1. Проверьте доступность сервера
2. Проверьте логи WildFly
3. Проверьте настройки переменных в JMeter
4. Убедитесь, что БД доступна и работает

