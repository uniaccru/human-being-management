# JMeter тест для распределенных транзакций

## Описание

Этот тест-план JMeter предназначен для проверки корректности работы распределенных транзакций при параллельных запросах импорта от нескольких пользователей.

## Структура файлов

```
jmeter/
├── distributed-transaction-test.jmx  # JMeter тест-план
├── test_files.csv                     # Список JSON файлов для импорта
├── test1.json                         # Тестовый JSON файл 1
├── test2.json                         # Тестовый JSON файл 2
├── test3.json                         # Тестовый JSON файл 3
└── README.md                          # Эта инструкция
```

## Подготовка

1. Убедитесь, что Apache JMeter установлен на вашем компьютере
   - Скачать можно с: https://jmeter.apache.org/download_jmeter.cgi
   - Или установить через пакетный менеджер (brew, apt, yum и т.д.)

2. Убедитесь, что приложение запущено и доступно:
   - Backend должен быть развернут на WildFly
   - MinIO должен быть запущен и настроен
   - База данных должна быть доступна

3. Проверьте настройки в тест-плане:
   - `SERVER_HOST` - хост сервера (по умолчанию: localhost)
   - `SERVER_PORT` - порт сервера (по умолчанию: 8080)
   - `API_PATH` - путь к API (по умолчанию: /api/import/humanbeings/file)

## Запуск теста

### Вариант 1: Через GUI JMeter

1. Откройте Apache JMeter GUI:
   ```bash
   jmeter
   ```

2. Откройте тест-план:
   - File → Open → выберите `distributed-transaction-test.jmx`

3. Настройте параметры (если нужно):
   - В Test Plan → User Defined Variables можно изменить:
     - `SERVER_HOST` - адрес сервера
     - `SERVER_PORT` - порт сервера

4. Установите путь к директории с JSON файлами:
   - В Thread Group → CSV Data Set Config → Filename
   - Или используйте системное свойство `jmeter.dir` при запуске

5. Запустите тест:
   - Нажмите зеленую кнопку "Start" (▶) или Ctrl+R

6. Просмотрите результаты:
   - View Results Tree - детальные результаты каждого запроса
   - Summary Report - сводная статистика

### Вариант 2: Через командную строку (рекомендуется для демонстрации)

1. Перейдите в директорию проекта:
   ```bash
   cd /Users/macbookair2020/Downloads/HumanRegistry
   ```

2. Запустите тест через командную строку:
   ```bash
   jmeter -n -t jmeter/distributed-transaction-test.jmx \
          -Jjmeter.dir=$(pwd)/jmeter \
          -JSERVER_HOST=localhost \
          -JSERVER_PORT=8080 \
          -l jmeter/results.jtl \
          -e -o jmeter/report
   ```

   Где:
   - `-n` - не-GUI режим
   - `-t` - путь к тест-плану
   - `-Jjmeter.dir` - путь к директории с JSON файлами (абсолютный путь)
   - `-JSERVER_HOST` - хост сервера
   - `-JSERVER_PORT` - порт сервера
   - `-l` - файл для сохранения результатов
   - `-e` - генерация HTML отчета
   - `-o` - директория для HTML отчета

3. После завершения теста откройте HTML отчет:
   ```bash
   open jmeter/report/index.html
   ```

### Вариант 3: Упрощенный запуск (если все файлы в одной директории)

Если вы запускаете JMeter из директории `jmeter/`, то можно использовать:

```bash
cd jmeter
jmeter -n -t distributed-transaction-test.jmx \
       -Jjmeter.dir=$(pwd) \
       -JSERVER_HOST=localhost \
       -JSERVER_PORT=8080 \
       -l results.jtl
```

## Параметры теста

- **Количество потоков**: 5 (можно изменить в Thread Group)
- **Ramp-up время**: 1 секунда (все потоки запускаются почти одновременно)
- **Количество итераций**: 1 (каждый поток выполняет 1 запрос)
- **Файлы для импорта**: test1.json, test2.json, test3.json (циклически распределяются между потоками)

## Что проверяет тест

1. **Параллельные запросы**: 5 потоков одновременно отправляют запросы на импорт
2. **Распределенные транзакции**: Каждый запрос должен корректно обработать двухфазный коммит (БД + MinIO)
3. **Отсутствие конфликтов**: Все запросы должны успешно обработаться без ошибок
4. **Целостность данных**: Данные должны корректно сохраниться и в БД, и в MinIO

## Ожидаемые результаты

- Все запросы должны вернуть HTTP 200 OK
- В ответе должен быть JSON с полем `success: true`
- В БД должны появиться новые записи HumanBeing
- В MinIO должны быть сохранены файлы
- В истории импорта должны появиться записи

## Проверка результатов

После выполнения теста проверьте:

1. **В приложении**:
   - Откройте раздел "Human Beings" - должны быть новые записи
   - Откройте раздел "Импорт" → "История" - должны быть записи об импорте

2. **В MinIO консоли** (http://localhost:9001):
   - В bucket `import-files` должны быть загруженные файлы

3. **В логах WildFly**:
   - Не должно быть ошибок транзакций
   - Должны быть логи о успешных коммитах

## Настройка для удаленного сервера

Если сервер запущен не на localhost, измените параметры:

```bash
jmeter -n -t jmeter/distributed-transaction-test.jmx \
       -Jjmeter.dir=$(pwd)/jmeter \
       -JSERVER_HOST=192.168.1.100 \
       -JSERVER_PORT=8080 \
       -l jmeter/results.jtl
```

## Устранение проблем

### Ошибка "File not found"
- Убедитесь, что путь `jmeter.dir` указывает на правильную директорию
- Используйте абсолютный путь: `$(pwd)/jmeter`

### Ошибка "Connection refused"
- Проверьте, что сервер запущен и доступен
- Проверьте правильность `SERVER_HOST` и `SERVER_PORT`

### Ошибка 400 Bad Request
- Проверьте формат JSON файлов
- Убедитесь, что все обязательные поля заполнены

### Ошибка 500 Internal Server Error
- Проверьте логи WildFly
- Убедитесь, что MinIO запущен и доступен
- Проверьте настройки переменных окружения на сервере


